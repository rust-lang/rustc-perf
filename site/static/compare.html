<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rustc performance data</title>
    <link rel="stylesheet" type="text/css" href="perf.css">
    <link rel="alternate icon" type="image/png" href="/favicon-32x32.png">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>
        ul li {
            margin: 0;
        }

        ul li input {
            vertical-align: middle;
            margin: 0 2px;

        }

        .section {
            display: flex;
            margin: 4px 0;
        }

        #commits {
            border: none;
            display: flex;
            padding: 0px;
        }

        .commit-input {
            width: 270px;
            display: flex;
            flex-direction: column;
        }

        .commit-input label {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 6px;
        }

        #metric {
            position: relative;
            height: 40px;
        }

        #stats {
            border-radius: 5px;
            width: 200px;
            font-size: 14px;
            margin-left: 52px;
        }

        #filters-toggle {
            cursor: pointer;
        }

        .section-heading {
            font-size: 16px;
        }

        .section .section-heading {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #filters-content .section-heading {
            font-size: 16px;
        }

        #filters {
            border: 1px black;
            border-style: dotted;
            margin: 16px 0px;
            border-radius: 10px;
        }

        #filter {
            margin-left: 52px;
        }

        input {
            border-radius: 5px;
            padding: 4px;
            font-size: 12px;
            height: 100%;
        }

        input[type="checkbox"] {
            height: auto;
        }

        #settings input[type=submit] {
            width: 100%;
            font-weight: bold;
            background: #ADD8E6;
            margin: 10px 0;
        }

        .cache-label {
            font-weight: bold;
        }

        #states-list {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 80%;
            list-style: none;
            margin: 0;
        }

        .tooltip {
            position: relative;
            border-radius: 50%;
            font-size: 12px;
            margin: 0 -4px;
            border: 1px solid #7d6969;
            width: 16px;
            text-align: center;
            font-weight: bold;
            background: #d6d3d3;
            cursor: pointer;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            width: 180px;
            visibility: hidden;
            color: white;
            background-color: #524d4d;
            text-align: center;
            padding: 5px;
            border-radius: 6px;

            position: absolute;
            bottom: 125%;
            margin-left: -60px;

            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
</head>

<body class="container" style="max-width:800px">
    <div>&gt; <a href="index.html">graphs</a>, <a href="compare.html">compare</a>,
        <a href="dashboard.html">dashboard</a>, <a href="bootstrap.html">bootstrap</a>,
        <a href="status.html">status</a>, <a href="help.html">help</a>.
    </div>
    <br />
    <h1>Comparing <span id="stat-header">instructions:u</span> between <span id="before">???</span> and <span
            id="after">???</span></h1>
    <fieldset id="settings">
        <legend id="search-toggle" class="section-heading">Do another comparison<span
                id="search-toggle-indicator"></span></legend>
        <div id="search-content">
            <div id="commits" class="section">
                <div class="section-heading">Commits</div>
                <div style="display: flex; width: 100%; justify-content: space-around;">
                    <div class="commit-input">
                        <label for="start-bound">Before</label>
                        <input width="100em" placeholder="YYYY-MM-DD or Commit SHA" id="start-bound" />
                    </div>
                    <div class="commit-input">
                        <label for="end-bound">After</label>
                        <input width="100em" placeholder="YYYY-MM-DD or Commit SHA" id="end-bound" />
                    </div>
                </div>
            </div>
            <div id="metric" class="section">
                <div class="section-heading" for="stats">Metric</div>
                <div style="display: flex; flex-direction: column; justify-content: center;">
                    <select id='stats' name="stat"></select>
                </div>
            </div>
            <input id="submit" type="submit" value="Submit" onclick="submit_settings(); return false;">
    </fieldset>
    </div>
    <fieldset id="filters">
        <legend id="filters-toggle" class="section-heading">Filters<span id="filters-toggle-indicator"></span></legend>
        <div id="filters-content" style="display: none;">
            <div class="section">
                <div class="section-heading">Filter by benchmark
                </div>
                <input id="filter" type="text" /> </p>
            </div>
            <div class="section">
                <div class="section-heading">
                    <div>
                        <span>Cache states</span>
                        <div class="tooltip">?<span class="tooltiptext">
                                Most benchmarks have at least 4 cache states for which we collect data
                        </div>
                    </div>
                </div>
                <ul id="states-list">
                    <li><input type="checkbox" id="build-full" checked /><span class="cache-label">full</span>
                        <div class="tooltip">?<span class="tooltiptext">A
                                non-incremental full build starting with empty cache</span></div>
                    </li>
                    <li><input type="checkbox" id="build-incremental-full" checked /> <span
                            class="cache-label">incr-full</span>
                        <div class="tooltip">?<span class="tooltiptext">An incremental build
                                starting
                                with empty cache
                            </span></div>
                    </li>
                    <li><input type="checkbox" id="build-incremental-unchanged" checked /> <span
                            class="cache-label">incr-unchanged</span>
                        <div class="tooltip">?<span class="tooltiptext">An
                                incremental
                                build
                                starting with complete
                                cache, and unchanged source directory -- the "perfect" scenario for incremental.</span>
                        </div>
                    </li>
                    <li><input type="checkbox" id="build-incremental-patched" checked /><span
                            class="cache-label">incr-patched</span>
                        <div class="tooltip">?<span class="tooltiptext">An incremental
                                build
                                starting with complete cache, and an
                                altered source directory. The typical variant of this is "println" which represents
                                the addition of a `println!` macro somewhere in the source code.</span></div>
                    </li>
                </ul>
            </div>
        </div>
    </fieldset>
    <div id="content" style="margin-top: 15px">
        <table v-if="data" class="compare" style="font-size: medium !important;">
            <thead>
                <tr>
                    <td v-if="notContinuous" colspan="4" style="text-align:center;"><b>Warning</b>: The start and end
                        are not adjacent!</td>
                </tr>
                <tr>
                    <th>
                        <a v-bind:href="compareLink">compare</a>
                    </th>
                    <th>
                        <a v-if="data.prev" v-bind:href="prevLink">&larr;</a>
                        {{formatDate(data.a.date)}}
                        (<a>{{short(data.a)}}</a>)
                    </th>
                    <th>
                        {{formatDate(data.b.date)}}
                        (<a>{{short(data.b)}}</a>)
                        <a v-if="data.next" v-bind:href="nextLink">&rarr;</a>
                    </th>
                    <th>% change</th>
                </tr>
                <tr>
                    <th></th>
                    <th style="text-align: left;"><a v-if="data.a.pr" v-bind:href="prLink(data.a.pr)">#{{data.a.pr}}</a>
                    </th>
                    <th style="text-align: left;"><a v-if="data.b.pr" v-bind:href="prLink(data.b.pr)">#{{data.b.pr}}</a>
                    </th>
                </tr>
            </thead>
            <tbody>
                <template v-for="bench in benches">
                    <tr data-field-start="true">
                        <th>
                            <details class="toggle-table" v-on:toggle="benchGroupToggle">
                                <summary>{{ trimBenchName(bench.name) }}</summary>
                            </details>
                        </th>
                        <td>avg: <span v-bind:class="percentClass(bench.avg_pct)">{{bench.avg_pct}}</span></td>
                        <td>min: <span v-bind:class="percentClass(bench.min_pct)">{{bench.min_pct}}</span></td>
                        <td>max: <span
                                v-bind:class="percentClass(bench.max_pct)">{{bench.max_pct}}%{{isDodgyBench(bench)
                                ? "?" : ""}}</span></td>
                    </tr>
                    <template v-for="run in bench.fields">
                        <tr>
                            <td>{{ run.casename }}</td>
                            <td>
                                <a v-bind:href="detailedQueryLink(data.a.commit, bench.name, run.casename)">
                                    {{ run.datum_a }}
                                </a>
                            </td>
                            <td>
                                <a v-bind:href="detailedQueryLink(data.b.commit, bench.name, run.casename)">
                                    {{ run.datum_b }}
                                </a>
                            </td>
                            <td>
                                <a v-bind:href="percentLink(data.b.commit, data.a.commit, bench.name, run.casename)">
                                    <span v-bind:class="percentClass(run.percent)">{{ run.percent }}%{{run.isDodgy ? "?"
                                        : ""}}</span>
                                </a>
                            </td>
                        </tr>
                    </template>
                </template>
            </tbody>
        </table>
    </div>
    <br>
    <div id="as-of"></div>
    <a href="https://github.com/rust-lang-nursery/rustc-perf">
        <img style="position: absolute; top: 0; right: 0; border: 0;"
            src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67"
            alt="Fork me on GitHub"
            data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png">
    </a>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/msgpack-lite/0.1.26/msgpack.min.js"></script>
    <script src="shared.js"></script>
    <script>
        let app = new Vue({
            el: '#content',
            data: {
                data: null
            },
            computed: {
                notContinuous: function () {
                    return !this.data.is_contiguous;
                },
                prevLink: function () {
                    return `/compare.html?start=${this.data.prev}&end=${this.data.a.commit}`;
                },
                nextLink: function () {
                    return `/compare.html?start=${this.data.b.commit}&end=${this.data.next}`;
                },
                compareLink: function () {
                    return `https://github.com/rust-lang/rust/compare/${this.data.a.commit}...${this.data.b.commit}`;
                },
                benches: function () {
                    let data = this.data;

                    function shouldShowBuild(name) {
                        if (name == "full") {
                            return document.querySelector("#build-full").checked;
                        } else if (name == "incr-full") {
                            return document.querySelector("#build-incremental-full").checked;
                        } else if (name == "incr-unchanged") {
                            return document.querySelector("#build-incremental-unchanged").checked;
                        } else if (name.startsWith("incr-patched")) {
                            return document.querySelector("#build-incremental-patched").checked;
                        } else {
                            // Unknown, but by default we should show things
                            return true;
                        }
                    }
                    function to_fields(name) {
                        let source = data.a.data[name] || data.b.data[name];
                        let max_length = 0;
                        if (data.a.data[name]) {
                            max_length = data.a.data[name].length;
                        }
                        if (data.b.data[name] && data.b.data[name].length > max_length) {
                            max_length = data.b.data[name].length;
                        }

                        let keys = {};
                        if (data.a.data[name]) {
                            for (let i = 0; i < data.a.data[name].length; i++) {
                                if (!keys[data.a.data[name][i][0]]) {
                                    keys[data.a.data[name][i][0]] = {};
                                }
                                keys[data.a.data[name][i][0]].a_idx = i;
                            }
                        }
                        if (data.b.data[name]) {
                            for (let i = 0; i < data.b.data[name].length; i++) {
                                if (!keys[data.b.data[name][i][0]]) {
                                    keys[data.b.data[name][i][0]] = {};
                                }
                                keys[data.b.data[name][i][0]].b_idx = i;
                            }
                        }

                        let fields = [];
                        for (let key in keys) {
                            let a_idx = keys[key].a_idx;
                            let b_idx = keys[key].b_idx;
                            let datum_a = null;
                            let datum_b = null;
                            if (a_idx != undefined && b_idx != undefined) {
                                datum_a = data.a.data[name][a_idx][1];
                                datum_b = data.b.data[name][b_idx][1];
                            } else if (a_idx != undefined) {
                                datum_a = data.a.data[name][a_idx][1];
                            } else if (b_idx != undefined) {
                                datum_b = data.b.data[name][b_idx][1];
                            } else {
                                // should be unreachable
                            }

                            let isDodgy = false;
                            if (data.variance) {
                                let variance = data.variance[name + "-" + key];
                                isDodgy = !!(variance && variance.description && variance.description.type != "Normal");
                            }
                            if (shouldShowBuild(key)) {
                                fields.push({
                                    casename: key,
                                    datum_a,
                                    datum_b,
                                    percent: percent_chg(datum_a, datum_b).toFixed(1),
                                    isDodgy,
                                });
                            }
                        }

                        return fields;
                    }

                    let test_names = unique([
                        ...Object.keys(data.a.data),
                        ...Object.keys(data.b.data),
                    ]);
                    // let bootstrap_names = unique([
                    //     ...Object.keys(data.a.bootstrap),
                    //     ...Object.keys(data.b.bootstrap),
                    // ]);

                    let fields = [
                        // ...bootstrap_names
                        //     .map(name => name)
                        //     .map(name => ({ name, is_bootstrap: true, fields: to_fields_bootstrap(name) })),
                        ...test_names.map(name => { return { name, fields: to_fields(name) } })
                    ];

                    for (let field of fields) {
                        let pcts = field.fields.map(field => parseFloat(field.percent))
                            .filter(p => p != undefined && p != null);
                        field.max_pct = Math.max(...pcts).toFixed(1);
                        field.min_pct = Math.min(...pcts).toFixed(1);
                        field.farthest_pct = Math.max(...pcts.map(p => Math.abs(p)));
                        let sum = pcts.reduce((a, b) => a + b, 0);
                        let avg = sum / pcts.length;
                        field.avg_pct = avg.toFixed(1);
                        field.max_casename_len = Math.max(...field.fields.map(f => f.casename.length));
                    }

                    fields.sort((a, b) => {
                        if (a.is_bootstrap == b.is_bootstrap) {
                            return b.farthest_pct - a.farthest_pct;
                        }
                        else {
                            if (a.is_bootstrap) {
                                return 1;
                            }
                            else {
                                return -1;
                            }
                        }
                    });
                    return fields;
                }
            },
            methods: {
                short: function (comparison) {
                    return shortCommit(comparison.commit);
                },
                prLink: function (pr) {
                    return `https://github.com/rust-lang/rust/pull/${pr}`;
                },
                percentClass: function (pct) {
                    let klass = "";
                    if (pct > 1) {
                        klass = 'positive';
                    } else if (pct > 0.1) {
                        klass = 'slightly-positive';
                    } else if (pct < -1) {
                        klass = 'negative';
                    } else if (pct < -0.1) {
                        klass = 'slightly-negative';
                    }
                    return klass;

                },
                detailedQueryLink(commit, bench, run) {
                    return `/detailed-query.html?commit=${commit}&benchmark=${bench}&run_name=${run}`;
                },
                percentLink(commit, baseCommit, bench, run) {
                    return `/detailed-query.html?commit=${commit}&base_commit=${baseCommit}&benchmark=${bench}&run_name=${run}`;
                },
                benchGroupToggle(e) {
                    const element = e.target;
                    toggleBenchGroup(element);
                },
                formatDate(date) {
                    return print_date(new Date(date));
                },
                trimBenchName(name) {
                    let result = name.substring(0, 25)
                    if (result != name) {
                        result = result + "...";

                    }
                    return result;
                },
                isDodgyBench(bench) {
                    return bench.fields.some(f => f.isDodgy);
                }
            },
            watch: {
                data: function (newVal, oldVal) {
                    if (newVal && !oldVal) {
                        this.$nextTick(() => {
                            for (let element of document.querySelectorAll(".toggle-table")) {
                                toggleBenchGroup(element);
                            }
                        });
                    }
                }
            }
        })
        function toggleBenchGroup(element) {
            let next = element.parentElement.parentElement.nextElementSibling;
            let inBody = []
            while (next && next.getAttribute("data-field-start") !== "true") {
                if (element.open) {
                    next.style.display = "";
                } else {
                    next.style.display = "none";
                }
                next = next.nextElementSibling;
            }
        }
        function toggleFilters(id, toggle) {
            let styles = document.getElementById(id).style;
            let indicator = document.getElementById(toggle);
            if (styles.display != "none") {
                indicator.innerHTML = "⯈"
                styles.display = "none";
            } else {
                indicator.innerHTML = "▼"
                styles.display = "block";
            }
        }
        toggleFilters("filters-content", "filters-toggle-indicator");
        toggleFilters("search-content", "search-toggle-indicator");

        document.getElementById("filters-toggle").onclick = (e) => {
            toggleFilters("filters-content", "filters-toggle-indicator");
        };
        document.getElementById("search-toggle").onclick = (e) => {
            toggleFilters("search-content", "search-toggle-indicator");
        };


        function print_date(date) {
            function pad_str(i) {
                return (i < 10) ? "0" + i : "" + i;
            }

            return `${date.getUTCFullYear()}-${pad_str(date.getUTCMonth() + 1)}-${pad_str(date.getUTCDate())} `;
        }

        function unique(arr) {
            return arr.filter((value, idx) => arr.indexOf(value) == idx);
        }

        function add_datum_fields(datum, sha, bench, run, selfProfileAvailable) {
            let html = "";
            if (datum) {
                html += "<td>";
                let txt = "";
                if (Number.isInteger(datum)) {
                    txt = datum + "";
                } else {
                    txt = datum.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
                }
                if (selfProfileAvailable) {
                    html += `< a href = "/detailed-query.html?commit=${sha}&benchmark=${bench}&run_name=${run}" > ${txt}</a > `;
                } else {
                    html += txt;
                }
                html += "</td>";
            } else {
                html += "<td>-</td>";
            }
            return html;
        }

        function percent_chg(a, b) {
            if (a && b) {
                return 100 * (b - a) / a;
            } else {
                return null;
            }
        }

        function add_percent(pct, dodgy, dodgy_marker) {
            if (pct != null && pct != Infinity && pct != -Infinity) {
                let klass = "";
                if (pct > 1) {
                    klass = 'class="positive"';
                } else if (pct > 0.1) {
                    klass = 'class="slightly-positive"';
                } else if (pct < -1) {
                    klass = 'class="negative"';
                } else if (pct < -0.1) {
                    klass = 'class="slightly-negative"';
                }
                let title = "";
                let marker = "";
                if (dodgy) {
                    title = `title = "${dodgy}"`;
                    marker = dodgy_marker;
                }
                return `< span ${klass} ${title}> ${pct.toFixed(1)}% ${marker}</span > `;
            } else {
                return "<span>-</span>"
            }
        }

        function shortCommit(commit) {
            return commit.substring(0, 8);
        }

        function populate_data(data) {
            app.data = data;
            {
                let filter = document.querySelector("#filter").value;
                let test_names = unique([
                    ...Object.keys(data.a.data),
                    ...Object.keys(data.b.data),
                    ...Object.keys(data.a.bootstrap),
                    ...Object.keys(data.b.bootstrap),
                ]);
                let is_copied = false;
                for (let name of test_names) {
                    if (!name.includes(filter)) {
                        if (!is_copied) {
                            // Copying data is very expensive
                            // This branch ensures that we avoid copying
                            // if there are no filters (which is the most common case)
                            data = JSON.parse(JSON.stringify(DATA)); // deep copy
                            is_copied = true;
                        }
                        if (data.a.data[name]) delete data.a.data[name];
                        if (data.b.data[name]) delete data.b.data[name];
                        if (data.a.bootstrap[name]) delete data.a.bootstrap[name];
                        if (data.b.bootstrap[name]) delete data.b.bootstrap[name];
                    }
                }
            }

            function shouldShowBuild(name) {
                if (name == "full") {
                    return document.querySelector("#build-full").checked;
                } else if (name == "incr-full") {
                    return document.querySelector("#build-incremental-full").checked;
                } else if (name == "incr-unchanged") {
                    return document.querySelector("#build-incremental-unchanged").checked;
                } else if (name.startsWith("incr-patched")) {
                    return document.querySelector("#build-incremental-patched").checked;
                } else {
                    // Unknown, but by default we should show things
                    return true;
                }
            }

            let html = "";

            html += `< table class="compare" style = "font-size: medium !important;" > `;
            html += "<thead>";

            if (!data.is_contiguous) {
                html += `< tr > <td colspan=4 style = "text-align:center;" > `;
                html += `< b > Warning</b >: The start and end are not adjacent!`;
                html += `</td ></tr > `;
            }

            // Heading: the two dates, and the time and rss percent changes.
            html += "<tr>";

            html += "<th>" + "<a href=\"" +
                "https://github.com/rust-lang/rust/compare/" + data.a.commit + "..." +
                data.b.commit +
                "\">compare</a>" + "</th>";

            let prev_link = "";
            if (data.prev) {
                let params = new URLSearchParams(window.location.search);
                params.set("end", params.get("start"));
                params.set("start", data.prev);
                prev_link = `< a href = "/compare.html?${params.toString()}" >& larr;</a > `;
            }
            let next_link = "";
            if (data.next) {
                let params = new URLSearchParams(window.location.search);
                params.set("start", params.get("end"));
                params.set("end", data.next);
                next_link = ` < a href = "/compare.html?${params.toString()}" >& rarr;</a > `;
            }
            html += "<th>"
                + prev_link + ""
                + print_date(new Date(data.a.date))
                + ` (<a href="https://github.com/rust-lang/rust/commit/${data.a.commit}"
                    >${data.a.commit.substring(0, 8)}</a>)` + "</th>";
            html += "<th>" + print_date(new Date(data.b.date))
                + ` (<a href="https://github.com/rust-lang/rust/commit/${data.b.commit}"
                    >${data.b.commit.substring(0, 8)}</a>)`
                + next_link
                + "</th>";

            html += "<th>" + "% change" + "</th>";
            html += "</tr>";

            html += "<tr>";
            html += "<th></th>";
            html += `< th style = "text-align:left;" > ${data.a.pr ? `<a
            href="https://github.com/rust-lang/rust/pull/${data.a.pr}">#${data.a.pr}</a>` : ""
                }</th > `;
            html += `< th style = "text-align:left;" > ${data.b.pr ? `<a
            href="https://github.com/rust-lang/rust/pull/${data.b.pr}">#${data.b.pr}</a>` : ""
                }</th > `;
            html += "</tr>";

            html += "</thead>";

            let test_names = unique([
                ...Object.keys(data.a.data),
                ...Object.keys(data.b.data),
            ]);
            let bootstrap_names = unique([
                ...Object.keys(data.a.bootstrap),
                ...Object.keys(data.b.bootstrap),
            ]);

            let fields = [
                ...bootstrap_names
                    .map(name => name)
                    .map(name => ({ name, is_bootstrap: true, fields: to_fields_bootstrap(name) })),
                ...test_names.map(name => ({ name, is_bootstrap: false, fields: to_fields(name) })),
            ];

            function to_fields_bootstrap(name) {
                let datum_a = data.a.bootstrap[name] || null;
                let datum_b = data.b.bootstrap[name] || null;
                datum_a = datum_a ? datum_a / 1e9 : null;
                datum_b = datum_b ? datum_b / 1e9 : null;

                return [
                    {
                        casename: name,
                        datum_a,
                        datum_b,
                        percent: percent_chg(datum_a, datum_b),
                    }
                ];
            }

            function to_fields(name) {
                let source = data.a.data[name] || data.b.data[name];
                let max_length = 0;
                if (data.a.data[name]) {
                    max_length = data.a.data[name].length;
                }
                if (data.b.data[name] && data.b.data[name].length > max_length) {
                    max_length = data.b.data[name].length;
                }

                let keys = {};
                if (data.a.data[name]) {
                    for (let i = 0; i < data.a.data[name].length; i++) {
                        if (!keys[data.a.data[name][i][0]]) {
                            keys[data.a.data[name][i][0]] = {};
                        }
                        keys[data.a.data[name][i][0]].a_idx = i;
                    }
                }
                if (data.b.data[name]) {
                    for (let i = 0; i < data.b.data[name].length; i++) {
                        if (!keys[data.b.data[name][i][0]]) {
                            keys[data.b.data[name][i][0]] = {};
                        }
                        keys[data.b.data[name][i][0]].b_idx = i;
                    }
                }

                let fields = [];
                for (let key in keys) {
                    let a_idx = keys[key].a_idx;
                    let b_idx = keys[key].b_idx;
                    let datum_a = null;
                    let datum_b = null;
                    if (a_idx != undefined && b_idx != undefined) {
                        datum_a = data.a.data[name][a_idx][1];
                        datum_b = data.b.data[name][b_idx][1];
                    } else if (a_idx != undefined) {
                        datum_a = data.a.data[name][a_idx][1];
                    } else if (b_idx != undefined) {
                        datum_b = data.b.data[name][b_idx][1];
                    } else {
                        // should be unreachable
                    }
                    if (shouldShowBuild(key)) {
                        fields.push({
                            casename: key,
                            datum_a,
                            datum_b,
                            percent: percent_chg(datum_a, datum_b),
                        });
                    }
                }

                return fields;
            }

            for (let field of fields) {
                let pcts = field.fields.map(field => field.percent)
                    .filter(p => p != undefined && p != null);
                field.max_pct = Math.max(...pcts);
                field.min_pct = Math.min(...pcts);
                field.farthest_pct = Math.max(...pcts.map(p => Math.abs(p)));
                let sum = pcts.reduce((a, b) => a + b, 0);
                let avg = sum / pcts.length;
                field.avg_pct = avg;
                field.max_casename_len = Math.max(...field.fields.map(f => f.casename.length));
            }

            fields.sort((a, b) => {
                if (a.is_bootstrap == b.is_bootstrap) {
                    return b.farthest_pct - a.farthest_pct;
                }
                else {
                    if (a.is_bootstrap) {
                        return 1;
                    }
                    else {
                        return -1;
                    }
                }
            });

            let max_name_width = Math.max(...fields.map(f => f.max_casename_len));

            function dodgy_name_title() {
                return "One or more of this benchmark's runs have high measurement variation. " +
                    "Treat this value with caution. And see the warning at the bottom of " +
                    "the table.";
            }

            function dodgy_casename_title(name, casename, variance) {
                if (!variance) {
                    return "";
                }

                if (variance.type == "HighlyVariable") {
                    return `This measurement varies a lot.Do not trust it!`
                }
                if (variance.type == "Noisy") {
                    return `This measurement is noisy.Do not trust it!`
                }
                return "";
            }

            let is_first_bootstrap = true;
            for (let field of fields) {
                let is_dodgy = Object.keys(data.variance || {}).some(k => {
                    let variance = data.variance[k];
                    return k.startsWith(field.name) && variance && variance.description.type != "Normal";
                });
                let dodgy = is_dodgy ? dodgy_name_title() : "";
                if (field.is_bootstrap) {
                    if (is_first_bootstrap) {
                        html += "<tr data-field-start=true><td>&nbsp;</td></tr>";
                        html += "<tr data-field-start=true><td colspan=4>bootstrap timings; variance is 1-3% on smaller benchmarks! Values in seconds.</td></tr>";
                        is_first_bootstrap = false;

                        html += "<tr data-field-start=true>";
                        html += `< th style = "width: ${max_name_width / 2}em;" data - js - name=Total > ` + truncate_name("total") + "</th>";
                        let sum = (acc, value) => acc + value;
                        let a_total = fields.filter(f => f.is_bootstrap).map(f => f.fields[0].datum_a).reduce(sum);
                        let b_total = fields.filter(f => f.is_bootstrap).map(f => f.fields[0].datum_b).reduce(sum);
                        html += add_datum_fields(a_total, data.a.commit, "Total", "", false);
                        html += add_datum_fields(b_total, data.b.commit, "Total", "", false);
                        let pct = add_percent(percent_chg(a_total, b_total), dodgy, "??");
                        html += `< td > ${pct}</td > `;
                        html += "</tr>";
                    }
                    html += "<tr data-field-start=true>";
                    html += `< th style = "width: ${max_name_width / 2}em;" data - js - name=${field.name}> ` + truncate_name(field.name) + "</th>";
                    let entry = field.fields[0];
                    html += add_datum_fields(entry.datum_a, data.a.commit,
                        field.name, entry.casename, false);
                    html += add_datum_fields(entry.datum_b, data.b.commit,
                        field.name, entry.casename, false);
                    let pct = add_percent(entry.percent, dodgy, "??");
                    html += `< td > ${pct}</td > `;
                    html += "</tr>";
                } else {
                    html += "<tr><td>&nbsp;</td></tr>";
                    html += "<tr data-field-start=true>";
                    html += `< th style = "width: ${max_name_width / 2}em;" data - js - name=${field.name}> ` +
                        `< details class=toggle - table > <summary>` +
                        truncate_name(field.name) + "</summary></details ></th > ";
                    html += "<td> avg: " + add_percent(field.avg_pct, dodgy, "?") + "</td>";
                    html += "<td text-align=center> min: " + add_percent(field.min_pct, dodgy, "?") +
                        "</td>";
                    html += "<td> max: " + add_percent(field.max_pct, dodgy, "?") + "</td>";
                    html += "</tr>";
                    for (let i = 0; i < field.fields.length; i++) {
                        let entry = field.fields[i];
                        const varianceKey = field.name + "-" + entry.casename;
                        const variance = data.variance && data.variance[varianceKey] && data.variance[varianceKey].description;
                        let dodgy = dodgy_casename_title(field.name, entry.casename, variance);
                        html += "<tr>";
                        html += "<td>" + entry.casename + "</td>";
                        // No base comparison commit for the first datum
                        html += add_datum_fields(entry.datum_a, data.a.commit,
                            field.name, entry.casename, true);
                        html += add_datum_fields(entry.datum_b, data.b.commit,
                            field.name, entry.casename, true);
                        let pct = add_percent(entry.percent, dodgy, "??");
                        let diff_href =
                            `/detailed-query.html?commit=${data.b.commit}&base_commit=${data.a.commit}&benchmark=${field.name}&run_name=${entry.casename}`;
                        html += `<td><a href="${diff_href}">${pct}</a></td>`;
                        html += "</tr>";
                    }
                }
            }

            html += "</table>";

            // document.getElementById("content").innerHTML = html;
            // document.getElementById("content").style.display = "block";
            for (let element of document.querySelectorAll(".toggle-table")) {
                let name = element.parentElement.getAttribute("data-js-name");
                let in_body = [];
                let next = element.parentElement.parentElement.nextElementSibling;
                while (next && next.getAttribute("data-field-start") !== "true") {
                    in_body.push(next);
                    next = next.nextElementSibling;
                }
                for (let detail of in_body) {
                    detail.style.display = "none";
                }
                element.addEventListener("toggle", evt => {
                    for (let detail of in_body) {
                        if (element.open) {
                            detail.style.display = "";
                        } else {
                            detail.style.display = "none";
                        }
                    }
                });
            }
        }

        var DATA;
        function make_data(state) {
            let values = Object.assign({}, {
                start: "",
                end: "",
                stat: "instructions:u",
            }, state);
            make_request("/get", values).then(function (data) {
                DATA = data;
                update_header(data.a.commit, data.b.commit);
                populate_data(data);
            });
        }

        function update_header(a, b, stat) {
            let shorten = (text) => {
                return text.substring(0, 7);
            }
            a && (document.getElementById("before").innerHTML = shorten(a));
            b && (document.getElementById("after").innerHTML = shorten(b));
            stat && (document.getElementById("stat-header").innerHTML = stat);
        }
        function findQueryParam(name) {
            let urlParams = window.location.search.substring(1).split("&").map(x => x.split("="));
            let pair = urlParams.find(x => x[0] === name)
            if (pair) {
                return unescape(pair[1]);
            }
        }
        let start = findQueryParam("start");
        let end = findQueryParam("end");
        let stat = findQueryParam("stat")
        update_header(start, end, stat);

        function submit_settings() {
            let start = document.getElementById("start-bound").value;
            let end = document.getElementById("end-bound").value;
            let stat = getSelected("stats");
            let params = new URLSearchParams();
            params.append("start", start);
            params.append("end", end);
            params.append("stat", stat);
            window.location.search = params.toString();
        }

        load_state(make_data);

        function rerender() {
            populate_data(DATA);
        }

        document.querySelector("#filter").addEventListener("change", rerender);
        document.querySelector("#build-full").addEventListener("change", rerender);
        document.querySelector("#build-incremental-full").addEventListener("change", rerender);
        document.querySelector("#build-incremental-unchanged").addEventListener("change", rerender);
        document.querySelector("#build-incremental-patched").addEventListener("change", rerender);

    </script>
</body>

</html>